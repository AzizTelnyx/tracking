!function(e){if(e.ClientTracker)return;const t={supabaseUrl:"https://xgcebeqshnnrljqhxgmn.supabase.co",supabaseKey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhnY2ViZXFzaG5ucmxqcWh4Z21uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzEyNDQ4ODMsImV4cCI6MjA0NjgyMDg4M30.UwnpcDQ_DqkZkefkuYmZf2eXUWij5JlwMGVn4D5EE_Y",debug:e.location.search.includes("hsdebug=true"),batchSize:10,batchDelay:2e3,sessionTimeout:30,retryAttempts:3};let i,o=t,n=1,a=new Date,r=0,s=!1,c=new Date,l=!0,m=[];const d=["gmail.com","yahoo.com","hotmail.com","outlook.com","aol.com","icloud.com","protonmail.com","mail.com"];async function u(e,t,i="POST",n=0){try{const n=${o.supabaseUrl}/rest/v1/${t},a="PATCH"===i?${n}?id=eq.${e.id}:${n}?select=id;o.debug&&console.log(Attempting to send data to ${t}:,e);const r=await fetch(a,{method:i,headers:{"Content-Type":"application/json",Authorization:Bearer ${o.supabaseKey},apikey:o.supabaseKey,Prefer:"return=representation"},body:JSON.stringify(Array.isArray(e)?e:[e])});if(!r.ok)throw new Error(HTTP error! status: ${r.status});const s=await r.json();return o.debug&&console.log(Successfully sent data to ${t}:,s),s}catch(a){if(o.debug&&console.error(Failed to send data to ${t}:,a),n<3)return await new Promise((e=>setTimeout(e,1e3*(n+1)))),u(e,t,i,n+1);const r=JSON.parse(localStorage.getItem("failed_events")||"[]");return r.push({eventData:e,table:t,method:i,timestamp:(new Date).toISOString()}),localStorage.setItem("failed_events",JSON.stringify(r)),await h(a,{operation:"sendTrackingData",table:t,method:i,retryCount:n,eventData:JSON.stringify(e)}),null}}function f(){const e=navigator.userAgent;return/(tablet|ipad|playbook|silk)|(android(?!.mobi))/i.test(e)?"Tablet":/Mobile|Android|iP(hone|od)|IEMobile|BlackBerry|Kindle|Silk-Accelerated|(hpw|web)OS|Opera M(obi|ini)/.test(e)?"Mobile":"Desktop"}function g(){const t=new URLSearchParams(e.location.search),i={utm_source:t.get("utm_source"),utm_medium:t.get("utm_medium"),utm_campaign:t.get("utm_campaign"),utm_term:t.get("utm_term"),utm_content:t.get("utm_content")},o={gclid:t.get("gclid"),fbclid:t.get("fbclid"),ttclid:t.get("ttclid"),msclkid:t.get("msclkid")};return Object.values(i).some((e=>e))&&sessionStorage.setItem("utm_params",JSON.stringify(i)),{...i,click_id:Object.entries(o).find((([e,t])=>t))?.[1]||null,click_id_type:Object.entries(o).find((([e,t])=>t))?.[0]||null}}function p(e){if(!e)return"Other";return{cpc:"Paid Search",ppc:"Paid Search",paidsearch:"Paid Search","paid-search":"Paid Search","social-paid":"Paid Social","social-cpc":"Paid Social",social_paid:"Paid Social",display:"Paid Display",banner:"Paid Display",cpm:"Paid Display",email:"Email","e-mail":"Email",newsletter:"Email",social:"Social Media","social-organic":"Social Media",affiliate:"Affiliates",partner:"Affiliates",organic:"Organic Search",referral:"Referral",direct:"Direct"}[e.toLowerCase()]||"Other"}async function _(){const e=function(){const e={userAgent:navigator.userAgent,language:navigator.language,platform:navigator.platform,screenResolution:${screen.width}x${screen.height},screenDepth:screen.colorDepth,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone};return Object.values(e).join("|")}();let t=sessionStorage.getItem("mp_visitor_id");if(t)return console.log("Returning visitor from session:",t),{id:t,fingerprint:e,isNew:!1};if(t=localStorage.getItem("mp_visitor_id"),t)return console.log("Returning visitor from local storage:",t),await u({id:t,last_seen_at:(new Date).toISOString(),updated_at:(new Date).toISOString()},"visitors","PATCH"),{id:t,fingerprint:e,isNew:!1};const i={first_fingerprint_id:e,first_seen_at:(new Date).toISOString(),last_seen_at:(new Date).toISOString(),additional_fingerprints:[]},o=await u(i,"visitors");return o&&o[0]?.id?(t=o[0].id,sessionStorage.setItem("mp_visitor_id",t),localStorage.setItem("mp_visitor_id",t),console.log("New visitor created:",t),{id:t,fingerprint:e,isNew:!0}):(console.error("Failed to create or identify visitor"),null)}async function h(t,i={}){const n={error_message:t.message,error_stack:t.stack,error_timestamp:(new Date).toISOString(),page_url:e.location.href,session_id:sessionStorage.getItem("mp_session_numeric_id"),visitor_id:sessionStorage.getItem("mp_visitor_id"),metadata:JSON.stringify({...i,userAgent:navigator.userAgent,timestamp:(new Date).toISOString()})};try{await u(n,"events","POST"),o.debug&&console.log("Error logged:",n)}catch(e){console.error("Failed to log error:",e);const t=JSON.parse(localStorage.getItem("failed_error_logs")||"[]");t.push(n),localStorage.setItem("failed_error_logs",JSON.stringify(t))}}const y="marketo",v="hubspot",S="pardot",w="gravity";function b(){const t={marketo:void 0!==e.MktoForms2,hubspot:void 0!==e.hbspt||void 0!==e._hsq,pardot:!!document.querySelector('script[src="pi.pardot.com"]'),gravity:"undefined"!=typeof jQuery&&!!document.querySelector('form[id^="gform_"]')},i=[];return t.marketo&&i.push(void e.MktoForms2.whenReady((function(e){e.onSubmit((function(){const t=e.getFormElem()[0],i=e.vals().Email;I({formId:t.id,formName:"Marketo Form",email:i,provider:y,formElement:t})}))}))),t.hubspot&&i.push(void e.addEventListener("message",(function(e){if("hsFormCallback"===e.data.type&&"onFormSubmit"===e.data.eventName){const t=e.data.data,i=t.find((e=>"email"===e.name))?.value;I({formId:hubspot_${e.data.id},formName:"HubSpot Form",email:i,provider:v})}}))),t.pardot&&i.push(void document.addEventListener("submit",(function(e){const t=e.target;if(t.action?.includes("pardot")){const e=t.querySelector('input[type="email"]')||t.querySelector('input[name*="email" i]');I({formId:t.id||"pardot_form",formName:"Pardot Form",email:e?.value,provider:S,formElement:t})}}))),t.gravity&&i.push(void jQuery(document).on("gform_confirmation_loaded",(function(e,t){const i=jQuery(#gform_${t}),o=i.find('input[type="email"], input[name*="email"]').first();I({formId:gravity_${t},formName:"Gravity Form",email:o.val(),provider:w,formElement:i[0]})}))),i.push((document.addEventListener("submit",(async function(e){const t=e.target;if(t.getAttribute("data-submitting"))return void e.preventDefault();if(t.setAttribute("data-submitting","true"),t.getAttribute("data-provider"))return;const i=Array.from(t.elements).find((e=>"email"===e.type||e.name?.toLowerCase().includes("email")||e.id?.toLowerCase().includes("email"))),o=Array.from(t.elements).find((e=>e.name?.toLowerCase().includes("company")||e.name?.toLowerCase().includes("organization")||e.id?.toLowerCase().includes("company")||e.id?.toLowerCase().includes("organization")));I({formId:t.id,formName:t.getAttribute("name")||"Standard Form",email:i?.value?.trim(),provider:"standard",formElement:t,companyName:o?.value?.trim()}),setTimeout((()=>t.removeAttribute("data-submitting")),1e3)})),void document.addEventListener("change",(function(e){const t=e.target;t.form&&O("form_field_complete",t.tagName,t.id,{fieldType:t.type,fieldName:t.name,isRequired:t.required,formId:t.form.id,formType:T(t.form)})})))),()=>i.forEach((e=>e&&e()))}async function I(t){try{if(!t||!t.formElement)throw new Error("Invalid form submission data");const i=t.email,n=i?i.split("@")[1]?.toLowerCase():null,a=n&&!d.includes(n),r=sessionStorage.getItem("mp_visitor_id");if(i&&r){const e={id:r,email:i,email_domain:n,is_identified:!0,identification_date:(new Date).toISOString(),identification_source:form_submission_${t.provider},updated_at:(new Date).toISOString()};try{await u(e,"visitors","PATCH"),a&&await async function(e,t,i,n){try{const a=await async function(e){try{const t=await fetch(${o.supabaseUrl}/rest/v1/companies?domain=eq.${e}&select=id,{headers:{Authorization:Bearer ${o.supabaseKey},apikey:o.supabaseKey}});if(!t.ok)throw new Error(HTTP error! status: ${t.status});return(await t.json())[0]}catch(e){return console.error("Error finding company:",e),null}}(e);if(a)await u({id:a.id,last_enrichment_at:(new Date).toISOString(),updated_at:(new Date).toISOString()},"companies","PATCH"),await u({id:i,company_id:a.id,updated_at:(new Date).toISOString()},"visitors","PATCH");else{const o={domain:e,name:t||e.split(".")[0],identified_via:"form_submission",identified_at:(new Date).toISOString(),status:"identified",company_data:JSON.stringify({first_visitor_id:i,first_seen_email:n})},a=await u(o,"companies");a?.[0]?.id&&await u({id:i,company_id:a[0].id,updated_at:(new Date).toISOString()},"visitors","PATCH")}}catch(e){console.error("Error handling company identification:",e)}}(n,t.companyName,r,i)}catch(e){console.error("Error identifying visitor:",e)}}const s={session_id:parseInt(sessionStorage.getItem("mp_session_numeric_id")),visitor_id:r,form_id:t.formId,form_name:t.formName,form_action:t.formElement?.action,page_url:e.location.href,email_domain:n,email:i,is_business_email:a,form_fields:JSON.stringify({has_company_field:!!t.companyName,has_email_field:!!i,company_name:t.companyName||null,provider:t.provider}),metadata:JSON.stringify({form_type:T(t.formElement),field_count:t.formElement?.elements?.length,has_required_fields:t.formElement?Array.from(t.formElement.elements).some((e=>e.required)):null})};try{await u(s,"form_submissions"),O("form_complete","FORM",t.formId,{formType:T(t.formElement),hasEmail:!!i,hasCompany:!!t.companyName,isBusinessEmail:a,provider:t.provider})}catch(e){console.error("Error tracking form submission:",e)}}catch(e){console.error("Error in handleFormSubmission:",e),await h(e,{operation:"handleFormSubmission",formId:t?.formId,provider:t?.provider})}}function O(t,i=null,o=null,a={}){u({session_id:n,event_type:t,event_timestamp:(new Date).toISOString(),page_url:e.location.href,element_type:i,element_id:o,other_data:JSON.stringify({...a,tab_active:l,time_since_last_activity:c?(new Date-c)/1e3:0,active_tab_time:0,session_ending:s})},"events")}function D(){let t=0;e.addEventListener("scroll",function(e,t){let i;return function(...o){clearTimeout(i),i=setTimeout((()=>e.apply(this,o)),t)}}((function(){const i=function(){const t=e.innerHeight,i=document.documentElement.scrollHeight,o=e.pageYOffset||document.documentElement.scrollTop;return Math.round((o+t)/i100)}();i>r&&(r=i,Math.floor(i/25)>Math.floor(t/25)&&(O("scroll_depth",null,null,{depth:25Math.floor(i/25)}),t=i))}),200))}let k=0,E=Date.now();function T(e){const t=e.outerHTML.toLowerCase();return t.includes("contact")||e.id?.toLowerCase().includes("contact")?"contact":t.includes("subscribe")||t.includes("newsletter")?"newsletter":t.includes("demo")||t.includes("trial")?"demo":"other"}async function N(){try{const t=await _();if(!t)return void(o.debug&&console.error("Failed to identify visitor"));console.log(Visitor identified: ${t.id}),sessionStorage.setItem("mp_visitor_id",t.id),n=Math.floor(1e9*Math.random()),console.log(Generated session numeric ID: ${n});const d=g();console.log("Retrieved URL Parameters:",d);const h=function(){const e=sessionStorage.getItem("utm_params");if(e){const t=JSON.parse(e);if(t.utm_source&&t.utm_medium)return{source:t.utm_source,medium:t.utm_medium,channel:p(t.utm_medium)}}const t=g();if(t.utm_source&&t.utm_medium)return{source:t.utm_source,medium:t.utm_medium,channel:p(t.utm_medium)};const i=document.referrer;if(!i)return{source:"direct",medium:"none",channel:"direct"};try{const e=new URL(i).hostname,t={google:{medium:"organic",channel:"Organic Search"},bing:{medium:"organic",channel:"Organic Search"},yahoo:{medium:"organic",channel:"Organic Search"},duckduckgo:{medium:"organic",channel:"Organic Search"}},o={"facebook.com":{medium:"social",channel:"Social Media"},"instagram.com":{medium:"social",channel:"Social Media"},"linkedin.com":{medium:"social",channel:"Social Media"},"twitter.com":{medium:"social",channel:"Social Media"},"t.co":{medium:"social",channel:"Social Media"},"tiktok.com":{medium:"social",channel:"Social Media"}};for(const[i,o]of Object.entries(t))if(e.includes(i))return{source:i.charAt(0).toUpperCase()+i.slice(1),medium:o.medium,channel:o.channel};for(const[t,i]of Object.entries(o))if(e.includes(t))return{source:t.split(".")[0].charAt(0).toUpperCase()+t.split(".")[0].slice(1),medium:i.medium,channel:i.channel};return{source:e,medium:"referral",channel:"Referral"}}catch(e){return console.error("Error parsing referrer:",e),{source:"direct",medium:"none",channel:"direct"}}}();console.log("Traffic Information:",h);const y={fingerprint_id:t.fingerprint,visitor_id:t.id,session_start:(new Date).toISOString(),entry_page_url:e.location.href,traffic_source:h.source,traffic_medium:h.medium,traffic_channel:h.channel,device_type:f(),country:Intl.DateTimeFormat().resolvedOptions().timeZone,click_id:d.click_id||null},v=await u(y,"sessions");if(!v?.[0]?.id)return void console.error("Failed to create session");const S=v[0].id;console.log(Session created with UUID: ${S}),sessionStorage.setItem("mp_session_uuid",S),sessionStorage.setItem("mp_session_numeric_id",n.toString());if(["utm_source","utm_medium","utm_campaign","utm_term","utm_content"].some((e=>d[e]))){const e={session_id:n,utm_source:d.utm_source,utm_medium:d.utm_medium,utm_campaign:d.utm_campaign,utm_term:d.utm_term,utm_content:d.utm_content};console.log("Storing UTM parameters:",e),await u(e,"utmparameters")}const w={session_id:n,page_url:e.location.href,visit_timestamp:(new Date).toISOString(),page_type:"page"};console.log("Recording initial page visit:",w),await u(w,"pagevisits"),b(),document.addEventListener("click",(function(e){const t=e.target.closest("a");if(!t)return;const i=t.href||"";[".pdf",".doc",".docx",".xls",".xlsx",".zip",".rar"].some((e=>i.toLowerCase().endsWith(e)))&&O("file_download","LINK",t.id,{fileName:i.split("/").pop(),fileType:i.split(".").pop().toLowerCase()})})),document.addEventListener("play",(function(e){"VIDEO"===e.target.tagName&&O("video_play","VIDEO",e.target.id,{videoSrc:e.target.currentSrc,videoDuration:e.target.duration})}),!0),document.addEventListener("pause",(function(e){"VIDEO"===e.target.tagName&&O("video_pause","VIDEO",e.target.id,{videoSrc:e.target.currentSrc,timeStamp:e.target.currentTime})}),!0),D(),document.addEventListener("visibilitychange",(()=>{l="visible"===document.visibilityState,l&&(c=new Date,s&&(s=!1,console.log("Session restored due to user activity")))})),["mousedown","keydown","scroll","touchstart"].forEach((e=>{document.addEventListener(e,(()=>{c=new Date,s&&(s=!1,console.log("Session restored due to user activity"))}))})),i=setInterval((()=>{if(!l)return;const e=(new Date-c)/1e3/60;e>=10&&!s&&(s=!0,O("session_inactive",null,null,{inactiveTime:e}))}),6e4),setInterval((function(){if(l){const e=Date.now();k+=e-E,E=e}}),1e3),setInterval((function(){l&&O("page_time_checkpoint",null,null,{activeTime:Math.round(k/1e3),totalTime:Math.round((Date.now()-a)/1e3)})}),3e5),setInterval((async()=>{if(!navigator.onLine)return;const e=JSON.parse(localStorage.getItem("failed_error_logs")||"[]");if(e.length>0){const t=[];for(const i of e)try{await u(i,"events","POST"),t.push(i)}catch(e){console.error("Failed to resend error log:",e)}localStorage.setItem("failed_error_logs",JSON.stringify(e.filter((e=>!t.includes(e)))))}const t=JSON.parse(localStorage.getItem("failed_events")||"[]");if(t.length>0){const e=[];for(const i of t)try{await u(i.eventData,i.table,i.method),e.push(i)}catch(e){console.error("Failed to resend event:",e)}localStorage.setItem("failed_events",JSON.stringify(t.filter((t=>!e.includes(t)))))}}),6e4),document.addEventListener("click",(function(e){const t=e.target.closest('a, button, [role="button"], input[type="submit"]');if(t){const e={type:t.tagName.toLowerCase(),id:t.id||"",text:t.innerText||t.value||"",href:t.href||"",classes:t.className};(t.closest("[data-track]")||e.href||"submit"===e.type||e.classes.includes("cta")||e.classes.includes("btn-primary"))&&O("click",e.type,e.id,{text:e.text,href:e.href})}})),e.addEventListener("beforeunload",(function(){console.log("Session ending, tracking session end data...");const t={id:S,session_end:(new Date).toISOString(),exit_page_url:e.location.href,other_data:JSON.stringify({total_active_time:Math.round(k/1e3),total_time:Math.round((Date.now()-a)/1e3),final_scroll_depth:r,tab_switches:0,last_active:c.toISOString(),inactivity_periods:m,is_tab_active:l})};try{navigator.sendBeacon(${o.supabaseUrl}/rest/v1/sessions,JSON.stringify({...t,headers:{"Content-Type":"application/json",Authorization:Bearer ${o.supabaseKey},apikey:o.supabaseKey}})),console.log("Session end data successfully sent using sendBeacon.")}catch(e){console.error("Failed to send session end data using sendBeacon:",e)}O("page_time_summary",null,null,{activeTime:Math.round(k/1e3),totalTime:Math.round((Date.now()-a)/1e3),isActive:l}),O("final_scroll_depth",null,null,{depth:r})})),console.log("Tracking initialized with session:",S)}catch(e){o.debug&&console.error("Error during startTracking:",e)}}function A(e={}){try{if(o={...t,...e},!o.supabaseUrl||!o.supabaseKey)throw new Error("Supabase URL and API key are required");N().catch((e=>{o.debug&&console.error("Tracking initialization failed:",e)}))}catch(e){console.error("Fatal initialization error:",e)}}if(e.initializeClientTracker=A,e.ClientTracker={init:A,track:function(e,t){O(e,null,null,t)}},e.google_tag_manager)try{const t=e.dataLayer?.find((e=>e.trackerConfig))?.trackerConfig;t&&A(t)}catch(e){console.error("GTM initialization error:",e)}const M=1e3;let C=0;async function I(e){const t=Date.now();t-C<M?console.log("Throttling form submission"):C=t}if(!email||function(e){return e&&e.includes("@")&&e.includes(".")}(email))if(!emailDomain||(L=emailDomain)&&L.includes(".")&&L.length>3)var L;else console.warn("Invalid email domain:",emailDomain);else console.warn("Invalid email format:",email)}(window);
